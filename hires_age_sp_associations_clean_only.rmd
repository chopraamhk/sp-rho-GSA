---
title: "hires_age_sp.rmd"
author: "Mehak Chopra"
date: "2025-07-08"
output: html_document
---

VSMCI
cell type specific gene expression with age 
```{r}
library(readr)
library(RegParallel)
library(data.table)
library(pheatmap)
library(ComplexHeatmap)
library(ComplexHeatmap)
library(circlize)
VSMCI <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_VSMC_I_Window52.txt")

transposed_data <- t(VSMCI)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)

vsmc_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- vsmc_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
vsmc_merge_clean <- cbind(vsmc_merge[, 1:3], as.data.frame(gene_data))

#VSMC -- spearman's correlation 
#cor.test(vsmc_merge_clean$age, vsmc_merge_clean$WASH7P, method = "spearman", exact = FALSE)

cor_vsmc <- sapply(vsmc_merge_clean[, 4:13716], function(col) {
  test <- suppressWarnings(cor.test(vsmc_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})


# Transpose and convert to data.frame
vsmc_cor_sp <- as.data.frame(t(cor_vsmc))
vsmc_cor_sp$Gene <- colnames(vsmc_merge_clean)[4:13716]

vsmc_cor_sp$p.adj <- p.adjust(vsmc_cor_sp$pval, method = "BH")

significant_cor_sp_vsmc <- vsmc_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's vsmc-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_vsmc <- lapply(vsmc_merge_clean[, 4:13716], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = vsmc_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_vsmc) <- colnames(vsmc_merge_clean)[4:13716]
#str(cor_results[[1]])
combined_cor_results_vsmc <- do.call(rbind, cor_results_vsmc)

#names(cor_results)
rownames(combined_cor_results_vsmc) <- names(cor_results_vsmc)

combined_cor_results_vsmc <- tibble::rownames_to_column(as.data.frame(combined_cor_results_vsmc), var = "Gene")

vsmc_se_sp <- merge(vsmc_cor_sp, combined_cor_results_vsmc , by= "Gene")

vsmc_se_sp_sign <- vsmc_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
vsmc_se_sp_positive <- vsmc_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
vsmc_se_sp_negative <- vsmc_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(vsmc_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/vsmc_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(vsmc_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/vsmc_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(vsmc_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/vsmc_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

VSMCII
```{r}
VSMCII <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_VSMC_II_Window52.txt")

transposed_data <- t(VSMCII)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

vsmcII_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- vsmcII_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
vsmcII_merge_clean <- cbind(vsmcII_merge[, 1:3], as.data.frame(gene_data))

#VSMCII -- spearman's correlation 
cor_vsmcII <- sapply(vsmcII_merge_clean[, 4:12095], function(col) {
  test <- suppressWarnings(cor.test(vsmcII_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
vsmcII_cor_sp <- as.data.frame(t(cor_vsmcII))
vsmcII_cor_sp$Gene <- colnames(vsmcII_merge_clean)[4:12095]

vsmcII_cor_sp$p.adj <- p.adjust(vsmcII_cor_sp$pval, method = "BH")

significant_cor_sp_vsmcII <- vsmcII_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's vsmcII-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_vsmcII <- lapply(vsmcII_merge_clean[, 4:12095], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = vsmcII_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_vsmcII) <- colnames(vsmcII_merge_clean)[4:12095]
#str(cor_results[[1]])
combined_cor_results_vsmcII <- do.call(rbind, cor_results_vsmcII)

#names(cor_results)
rownames(combined_cor_results_vsmcII) <- names(cor_results_vsmcII)

combined_cor_results_vsmcII <- tibble::rownames_to_column(as.data.frame(combined_cor_results_vsmcII), var = "Gene")

vsmcii_se_sp <- merge(vsmcII_cor_sp, combined_cor_results_vsmcII , by= "Gene")

vsmcii_se_sp_sign <- vsmcii_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
vsmcii_se_sp_positive <- vsmcii_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
vsmcii_se_sp_negative <- vsmcii_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(vsmcii_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/vsmcii_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(vsmcii_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/vsmcii_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(vsmcii_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/vsmcii_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Fibroblast-I
cell type specific gene expression with age 
```{r}
Fibroblast_I <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Fibroblast_I_Window52.txt")

transposed_data <- t(Fibroblast_I)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

fibroblastI_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- fibroblastI_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
fibroblastI_merge_clean <- cbind(fibroblastI_merge[, 1:3], as.data.frame(gene_data))

#FibroblastI -- spearman's correlation 
```

correlation in fibroblast I
```{r}
cor_fibroblastI <- sapply(fibroblastI_merge_clean[, 4:6038], function(col) {
  test <- suppressWarnings(cor.test(fibroblastI_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
fibroblastI_cor_sp <- as.data.frame(t(cor_fibroblastI))
fibroblastI_cor_sp$Gene <- colnames(fibroblastI_merge_clean)[4:6038]
fibroblastI_cor_sp$p.adj <- p.adjust(fibroblastI_cor_sp$pval, method = "BH")

significant_cor_sp_fibroblastI <- fibroblastI_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's fibroblastI-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_fibroblastI <- lapply(fibroblastI_merge_clean[, 4:6038], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = fibroblastI_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_fibroblastI) <- colnames(fibroblastI_merge_clean)[4:6038]
#str(cor_results[[1]])
combined_cor_results_fibroblastI <- do.call(rbind, cor_results_fibroblastI)

#names(cor_results)
rownames(combined_cor_results_fibroblastI) <- names(cor_results_fibroblastI)

combined_cor_results_fibroblastI <- tibble::rownames_to_column(as.data.frame(combined_cor_results_fibroblastI), var = "Gene")

fibroblastI_se_sp <- merge(fibroblastI_cor_sp, combined_cor_results_fibroblastI , by= "Gene")

fibroblastI_se_sp_sign <- fibroblastI_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
fibroblastI_se_sp_positive <- fibroblastI_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
fibroblastI_se_sp_negative <- fibroblastI_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(fibroblastI_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/fibroblastI_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(fibroblastI_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/fibroblastI_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(fibroblastI_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/fibroblastI_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Fibroblast-II
cell type specific gene expression with age 
```{r}
Fibroblast_II <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Fibroblast_II_Window52.txt")

transposed_data <- t(Fibroblast_II)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

fibroblastII_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- fibroblastII_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
fibroblastII_merge_clean <- cbind(fibroblastII_merge[, 1:3], as.data.frame(gene_data))
```

FibroblastII -- spearman's correlation 
```{r}
cor_fibroblastII <- sapply(fibroblastII_merge_clean[, 4:966], function(col) {
  test <- suppressWarnings(cor.test(fibroblastII_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
fibroblastII_cor_sp <- as.data.frame(t(cor_fibroblastII))
fibroblastII_cor_sp$Gene <- colnames(fibroblastII_merge_clean)[4:966]

fibroblastII_cor_sp$p.adj <- p.adjust(fibroblastII_cor_sp$pval, method = "BH")

significant_cor_sp_fibroblastII <- fibroblastII_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's fibroblastII-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_fibroblastII <- lapply(fibroblastII_merge_clean[, 4:966], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = fibroblastII_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_fibroblastII) <- colnames(fibroblastII_merge_clean)[4:966]
#str(cor_results[[1]])
combined_cor_results_fibroblastII <- do.call(rbind, cor_results_fibroblastII)

#names(cor_results)
rownames(combined_cor_results_fibroblastII) <- names(cor_results_fibroblastII)

combined_cor_results_fibroblastII <- tibble::rownames_to_column(as.data.frame(combined_cor_results_fibroblastII), var = "Gene")

fibroblastII_se_sp <- merge(fibroblastII_cor_sp, combined_cor_results_fibroblastII , by= "Gene")

fibroblastII_se_sp_sign <- fibroblastII_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
fibroblastII_se_sp_positive <- fibroblastII_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
fibroblastII_se_sp_negative <- fibroblastII_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(fibroblastII_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/fibroblastII_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(fibroblastII_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/fibroblastII_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(fibroblastII_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/fibroblastII_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Pericyte
cell type specific gene expression with age 
```{r}
Pericyte <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Pericyte_Window52.txt")

transposed_data <- t(Pericyte)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)#merging means of all
#df_list <- list(vsmc_genes, vsmcII_genes, fibroblastI_genes)

#data <- reshape::merge_recurse(df_list)
#data
#metadata

Pericyte_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- Pericyte_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
Pericyte_merge_clean <- cbind(Pericyte_merge[, 1:3], as.data.frame(gene_data))
```

Pericyte -- spearman's correlation 
```{r}
cor_Pericyte <- sapply(Pericyte_merge_clean[, 4:1740], function(col) {
  test <- suppressWarnings(cor.test(Pericyte_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
Pericyte_cor_sp <- as.data.frame(t(cor_Pericyte))
Pericyte_cor_sp$Gene <- colnames(Pericyte_merge_clean)[4:1740]

Pericyte_cor_sp$p.adj <- p.adjust(Pericyte_cor_sp$pval, method = "BH")

significant_cor_sp_Pericyte <- Pericyte_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's Pericyte-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_Pericyte <- lapply(Pericyte_merge_clean[, 4:1740], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = Pericyte_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_Pericyte) <- colnames(Pericyte_merge_clean)[4:1740]
#str(cor_results[[1]])
combined_cor_results_Pericyte <- do.call(rbind, cor_results_Pericyte)

#names(cor_results)
rownames(combined_cor_results_Pericyte) <- names(cor_results_Pericyte)

combined_cor_results_Pericyte <- tibble::rownames_to_column(as.data.frame(combined_cor_results_Pericyte), var = "Gene")

Pericyte_se_sp <- merge(Pericyte_cor_sp, combined_cor_results_Pericyte , by= "Gene")

Pericyte_se_sp_sign <- Pericyte_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
Pericyte_se_sp_positive <- Pericyte_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
Pericyte_se_sp_negative <- Pericyte_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(Pericyte_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/Pericyte_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(Pericyte_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/Pericyte_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(Pericyte_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/Pericyte_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Endothelial I
cell type specific gene expression with age 
```{r}
endothelialI <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Endothelial_I_Window52.txt")

transposed_data <- t(endothelialI)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

endothelialI_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- endothelialI_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
endothelialI_merge_clean <- cbind(endothelialI_merge[, 1:3], as.data.frame(gene_data))
```

endothelialI -- spearman's correlation 
```{r}
cor_endothelialI <- sapply(endothelialI_merge_clean[, 4:901], function(col) {
  test <- suppressWarnings(cor.test(endothelialI_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
endothelialI_cor_sp <- as.data.frame(t(cor_endothelialI))
endothelialI_cor_sp$Gene <- colnames(endothelialI_merge_clean)[4:901]

endothelialI_cor_sp$p.adj <- p.adjust(endothelialI_cor_sp$pval, method = "BH")

significant_cor_sp_endothelialI <- endothelialI_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's endothelialI-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_endothelialI <- lapply(endothelialI_merge_clean[, 4:901], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = endothelialI_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_endothelialI) <- colnames(endothelialI_merge_clean)[4:901]
#str(cor_results[[1]])
combined_cor_results_endothelialI <- do.call(rbind, cor_results_endothelialI)

#names(cor_results)
rownames(combined_cor_results_endothelialI) <- names(cor_results_endothelialI)

combined_cor_results_endothelialI <- tibble::rownames_to_column(as.data.frame(combined_cor_results_endothelialI), var = "Gene")

endothelialI_se_sp <- merge(endothelialI_cor_sp, combined_cor_results_endothelialI , by= "Gene")

endothelialI_se_sp_sign <- endothelialI_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
endothelialI_se_sp_positive <- endothelialI_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
endothelialI_se_sp_negative <- endothelialI_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(endothelialI_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/endothelialI_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(endothelialI_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/endothelialI_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")


#write.csv(endothelialI_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/endothelialI_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Endothelial II
cell type specific gene expression with age 
```{r}
endothelialII <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Endothelial_II_Window52.txt")

transposed_data <- t(endothelialII)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

endothelialII_merge <- merge(metadata, transposed_df, by = "Mixture")


# Convert all gene columns to numeric safely
gene_data <- endothelialII_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
endothelialII_merge_clean <- cbind(endothelialII_merge[, 1:3], as.data.frame(gene_data))
```

endothelialII -- spearman's correlation 
```{r}
cor_endothelialII <- sapply(endothelialII_merge_clean[, 4:1348], function(col) {
  test <- suppressWarnings(cor.test(endothelialII_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
endothelialII_cor_sp <- as.data.frame(t(cor_endothelialII))
endothelialII_cor_sp$Gene <- colnames(endothelialII_merge_clean)[4:1348]

endothelialII_cor_sp$p.adj <- p.adjust(endothelialII_cor_sp$pval, method = "BH")

significant_cor_sp_endothelialII <- endothelialII_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's endothelialII-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_endothelialII <- lapply(endothelialII_merge_clean[, 4:1348], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = endothelialII_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_endothelialII) <- colnames(endothelialII_merge_clean)[4:1348]
#str(cor_results[[1]])
combined_cor_results_endothelialII <- do.call(rbind, cor_results_endothelialII)

#names(cor_results)
rownames(combined_cor_results_endothelialII) <- names(cor_results_endothelialII)

combined_cor_results_endothelialII <- tibble::rownames_to_column(as.data.frame(combined_cor_results_endothelialII), var = "Gene")

endothelialII_se_sp <- merge(endothelialII_cor_sp, combined_cor_results_endothelialII , by= "Gene")

endothelialII_se_sp_sign <- endothelialII_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
endothelialII_se_sp_positive <- endothelialII_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
endothelialII_se_sp_negative <- endothelialII_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(endothelialII_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/endothelialII_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(endothelialII_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/endothelialII_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(endothelialII_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/endothelialII_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Lymphatic Endothelial 
cell type specific gene expression with age 
```{r}
lym_endothelial <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Lymphatic_Endothelial_Window52.txt")

transposed_data <- t(lym_endothelial)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

lym_endothelial_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- lym_endothelial_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
lym_endothelial_merge_clean <- cbind(lym_endothelial_merge[, 1:3], as.data.frame(gene_data))
```

lym_endothelial -- spearman's correlation 
```{r}
cor_lym_endothelial <- sapply(lym_endothelial_merge_clean[, 4:782], function(col) {
  test <- suppressWarnings(cor.test(lym_endothelial_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
lym_endothelial_cor_sp <- as.data.frame(t(cor_lym_endothelial))
lym_endothelial_cor_sp$Gene <- colnames(lym_endothelial_merge_clean)[4:782]

lym_endothelial_cor_sp$p.adj <- p.adjust(lym_endothelial_cor_sp$pval, method = "BH")

significant_cor_sp_lym_endothelial <- lym_endothelial_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's lym_endothelial-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_lym_endothelial <- lapply(lym_endothelial_merge_clean[, 4:782], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = lym_endothelial_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_lym_endothelial) <- colnames(lym_endothelial_merge_clean)[4:782]
#str(cor_results[[1]])
combined_cor_results_lym_endothelial <- do.call(rbind, cor_results_lym_endothelial)

#names(cor_results)
rownames(combined_cor_results_lym_endothelial) <- names(cor_results_lym_endothelial)

combined_cor_results_lym_endothelial <- tibble::rownames_to_column(as.data.frame(combined_cor_results_lym_endothelial), var = "Gene")

lym_endothelial_se_sp <- merge(lym_endothelial_cor_sp, combined_cor_results_lym_endothelial , by= "Gene")

lym_endothelial_se_sp_sign <- lym_endothelial_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
lym_endothelial_se_sp_positive <- lym_endothelial_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
lym_endothelial_se_sp_negative <- lym_endothelial_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(lym_endothelial_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/lym_endothelial_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(lym_endothelial_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/lym_endothelial_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(lym_endothelial_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/lym_endothelial_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Lymphocytes
cell type specific gene expression with age 
```{r}
lymphocyte <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Lymphocyte_Window52.txt")

transposed_data <- t(lymphocyte)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

lymphocyte_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- lymphocyte_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
lymphocyte_merge_clean <- cbind(lymphocyte_merge[, 1:3], as.data.frame(gene_data))
```

lymphocyte -- spearman's correlation 
```{r}
cor_lymphocyte <- sapply(lymphocyte_merge_clean[, 4:4133], function(col) {
  test <- suppressWarnings(cor.test(lymphocyte_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
lymphocyte_cor_sp <- as.data.frame(t(cor_lymphocyte))
lymphocyte_cor_sp$Gene <- colnames(lymphocyte_merge_clean)[4:4133]

lymphocyte_cor_sp$p.adj <- p.adjust(lymphocyte_cor_sp$pval, method = "BH")

significant_cor_sp_lymphocyte <- lymphocyte_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's lymphocyte-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_lymphocyte <- lapply(lymphocyte_merge_clean[, 4:4133], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = lymphocyte_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_lymphocyte) <- colnames(lymphocyte_merge_clean)[4:4133]
#str(cor_results[[1]])
combined_cor_results_lymphocyte <- do.call(rbind, cor_results_lymphocyte)

#names(cor_results)
rownames(combined_cor_results_lymphocyte) <- names(cor_results_lymphocyte)

combined_cor_results_lymphocyte <- tibble::rownames_to_column(as.data.frame(combined_cor_results_lymphocyte), var = "Gene")

lymphocyte_se_sp <- merge(lymphocyte_cor_sp, combined_cor_results_lymphocyte , by= "Gene")

lymphocyte_se_sp_sign <- lymphocyte_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
lymphocyte_se_sp_positive <- lymphocyte_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
lymphocyte_se_sp_negative <- lymphocyte_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(lymphocyte_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/lymphocyte_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(lymphocyte_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/lymphocyte_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(lymphocyte_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/lymphocyte_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Macrophage
cell type specific gene expression with age 
```{r}
macrophage <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Macrophage_Window52.txt")

transposed_data <- t(macrophage)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

macrophage_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- macrophage_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
macrophage_merge_clean <- cbind(macrophage_merge[, 1:3], as.data.frame(gene_data))
```

macrophage -- spearman's correlation 
```{r}
cor_macrophage <- sapply(macrophage_merge_clean[, 4:4621], function(col) {
  test <- suppressWarnings(cor.test(macrophage_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
macrophage_cor_sp <- as.data.frame(t(cor_macrophage))
macrophage_cor_sp$Gene <- colnames(macrophage_merge_clean)[4:4621]

macrophage_cor_sp$p.adj <- p.adjust(macrophage_cor_sp$pval, method = "BH")

significant_cor_sp_macrophage <- macrophage_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's macrophage-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_macrophage <- lapply(macrophage_merge_clean[, 4:4621], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = macrophage_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_macrophage) <- colnames(macrophage_merge_clean)[4:4621]
#str(cor_results[[1]])
combined_cor_results_macrophage <- do.call(rbind, cor_results_macrophage)

#names(cor_results)
rownames(combined_cor_results_macrophage) <- names(cor_results_macrophage)

combined_cor_results_macrophage <- tibble::rownames_to_column(as.data.frame(combined_cor_results_macrophage), var = "Gene")

macrophage_se_sp <- merge(macrophage_cor_sp, combined_cor_results_macrophage, by= "Gene")

macrophage_se_sp_sign <- macrophage_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
macrophage_se_sp_positive <- macrophage_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
macrophage_se_sp_negative <- macrophage_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(macrophage_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/macrophage_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(macrophage_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/macrophage_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(macrophage_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/macrophage_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Mesothelial
cell type specific gene expression with age 
```{r}
mesothelial <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Mesothelial_Window52.txt")

transposed_data <- t(mesothelial)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

mesothelial_merge <- merge(metadata, transposed_df, by = "Mixture")


# Convert all gene columns to numeric safely
gene_data <- mesothelial_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
mesothelial_merge_clean <- cbind(mesothelial_merge[, 1:3], as.data.frame(gene_data))
```

mesothelial -- spearman's correlation 
```{r}
cor_mesothelial <- sapply(mesothelial_merge_clean[, 4:2992], function(col) {
  test <- suppressWarnings(cor.test(mesothelial_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
mesothelial_cor_sp <- as.data.frame(t(cor_mesothelial))
mesothelial_cor_sp$Gene <- colnames(mesothelial_merge_clean)[4:2992]

mesothelial_cor_sp$p.adj <- p.adjust(mesothelial_cor_sp$pval, method = "BH")

significant_cor_sp_mesothelial <- mesothelial_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's mesothelial-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_mesothelial <- lapply(mesothelial_merge_clean[, 4:2992], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = mesothelial_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_mesothelial) <- colnames(mesothelial_merge_clean)[4:2992]
#str(cor_results[[1]])
combined_cor_results_mesothelial <- do.call(rbind, cor_results_mesothelial)

#names(cor_results)
rownames(combined_cor_results_mesothelial) <- names(cor_results_mesothelial)

combined_cor_results_mesothelial <- tibble::rownames_to_column(as.data.frame(combined_cor_results_mesothelial), var = "Gene")

mesothelial_se_sp <- merge(mesothelial_cor_sp, combined_cor_results_mesothelial, by= "Gene")

mesothelial_se_sp_sign <- mesothelial_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
mesothelial_se_sp_positive <- mesothelial_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
mesothelial_se_sp_negative <- mesothelial_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(mesothelial_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/mesothelial_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(mesothelial_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/mesothelial_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(mesothelial_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/mesothelial_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

Neuronal
cell type specific gene expression with age 
```{r}
neuronal <- fread("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/CIBERSORTxHiRes_NA_Neuron_Window52.txt")

transposed_data <- t(neuronal)

transposed_df <- as.data.frame(transposed_data)

transposed_df$Mixture <- rownames(transposed_df)

transposed_df <- transposed_df[, c(ncol(transposed_df), 1:(ncol(transposed_df)-1))]

rownames(transposed_df) <- NULL

#transposed_df

colnames(transposed_df) <- transposed_df[1, ]
transposed_df <- transposed_df[-1, ]

colnames(transposed_df)[1] <- "Mixture"

metadata <- read.table("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/gtex_metadata.txt", h=T)
#metadata

neuronal_merge <- merge(metadata, transposed_df, by = "Mixture")

# Convert all gene columns to numeric safely
gene_data <- neuronal_merge[, 4:54595]
gene_data <- lapply(gene_data, function(x) as.numeric(as.character(x)))

# Filter out genes with no variation
gene_data <- gene_data[sapply(gene_data, function(x) length(unique(x[!is.na(x)])) > 1)]

# Update the data frame
neuronal_merge_clean <- cbind(neuronal_merge[, 1:3], as.data.frame(gene_data))
```

neuronal -- spearman's correlation 
```{r}
cor_neuronal <- sapply(neuronal_merge_clean[, 4:106], function(col) {
  test <- suppressWarnings(cor.test(neuronal_merge_clean$age, col, method = "spearman"))
  c(cor = test$estimate, pval = test$p.value)
})

# Transpose and convert to data.frame
neuronal_cor_sp <- as.data.frame(t(cor_neuronal))
neuronal_cor_sp$Gene <- colnames(neuronal_merge_clean)[4:106]

neuronal_cor_sp$p.adj <- p.adjust(neuronal_cor_sp$pval, method = "BH")

significant_cor_sp_neuronal <- neuronal_cor_sp %>%
  dplyr::filter(p.adj < 0.05)
```

standard error from spearman's neuronal-----
```{r}
library(statpsych)

# Use lapply for clarity, then simplify to matrix/data.frame if needed
cor_results_neuronal <- lapply(neuronal_merge_clean[, 4:106], function(current_col_vector) {
  # Ensure the current column is numeric before attempting correlation
  if (is.numeric(current_col_vector)) {
    suppressWarnings(
      statpsych::ci.spear(alpha = 0.05, y = neuronal_merge_clean$age, x = current_col_vector)
    )
  } else {
    # Handle non-numeric columns, e.g., return NA or a specific message
    warning(paste("Column '", deparse(substitute(current_col_vector)), "' is not numeric and was skipped.", sep=""))
    return(NA) # Or some other indicator for skipped columns
  }
})

#names(cor_results)[1:5]

# Optional: simplify to matrix if all outputs are of same length/structure
names(cor_results_neuronal) <- colnames(neuronal_merge_clean)[4:106]
#str(cor_results[[1]])
combined_cor_results_neuronal <- do.call(rbind, cor_results_neuronal)

#names(cor_results)
rownames(combined_cor_results_neuronal) <- names(cor_results_neuronal)

combined_cor_results_neuronal <- tibble::rownames_to_column(as.data.frame(combined_cor_results_neuronal), var = "Gene")

neuronal_se_sp <- merge(neuronal_cor_sp, combined_cor_results_neuronal, by= "Gene")

neuronal_se_sp_sign <- neuronal_se_sp %>%
  dplyr::filter(p.adj < 0.05)

#positive rho 
neuronal_se_sp_positive <- neuronal_se_sp %>%
  dplyr::filter(Estimate > 0)

#negative rho
neuronal_se_sp_negative <- neuronal_se_sp %>%
  dplyr::filter(Estimate < 0)

#write.csv(neuronal_se_sp_positive, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/positive_corr_only/neuronal_se_positive.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(neuronal_se_sp_negative, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/negative_corr_only/neuronal_se_negative.csv", row.names = FALSE, quote = FALSE, sep = "\t")

#write.csv(neuronal_se_sp, "/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/gsea_spearman/all_genes/neuronal_se.csv", row.names = FALSE, quote = FALSE, sep = "\t")
```

upset plot from spearman correlation
```{r}
# Install and load UpSetR if you haven't
#install.packages("UpSetR")
library(UpSetR)

# Define gene sets
gene_sets_sp <- list(
  "VSMC-I" = rownames(significant_cor_sp_vsmc),
  "VSMC-II" = rownames(significant_cor_sp_vsmcII),
  "Pericyte" = rownames(significant_cor_sp_Pericyte),
  "Fibroblast-I" = rownames(significant_cor_sp_fibroblastI),
  "Fibroblast-II" = rownames(significant_cor_sp_fibroblastII),
  "Endothelial-I" = rownames(significant_cor_sp_endothelialI),
  "Endothelial-II" = rownames(significant_cor_sp_endothelialII),
  "Lymphatic Endothelial" = rownames(significant_cor_sp_lym_endothelial),
  "Lymphocyte" = rownames(significant_cor_sp_lymphocyte),
  "Macrophage" = rownames(significant_cor_sp_macrophage),
  "Mesothelial" = rownames(significant_cor_sp_mesothelial),
  "Neuronal" = rownames(significant_cor_sp_neuronal)
)

input_df_sp <- fromList(gene_sets_sp)
#dim(input_df)

#png("upset_plot_sp_cor.png", width = 1800, height = 800, res = 150)

# Draw the UpSet plot (do NOT assign to `p`)
upset(input_df_sp, nsets = 12, order.by = "freq")

# Close the device
#dev.off()
```

R-values 
```{r}
names(significant_cor_sp_vsmc)[1] <- "VSMC-I"
names(significant_cor_sp_vsmcII)[1] <- "VSMC-II"
names(significant_cor_sp_fibroblastI)[1] <- "Fibroblast-I"
names(significant_cor_sp_fibroblastII)[1] <- "Fibroblast-II"
names(significant_cor_sp_Pericyte)[1] <- "Pericyte"
names(significant_cor_sp_endothelialI)[1] <- "Endothelial-I"
names(significant_cor_sp_endothelialII)[1] <- "Endothelial-II"
names(significant_cor_sp_lym_endothelial)[1] <- "Lymphatic Endothelial"
names(significant_cor_sp_lymphocyte)[1] <- "Lymphocyte"
names(significant_cor_sp_macrophage)[1] <- "Macrophage"
names(significant_cor_sp_mesothelial)[1] <- "Mesothelial"
names(significant_cor_sp_neuronal)[1] <- "Neuronal"

r_sp_vsmc <- significant_cor_sp_vsmc[, c(3, 1)]
r_sp_vsmcII <- significant_cor_sp_vsmcII[, c(3, 1)]
r_sp_fibroblastI <- significant_cor_sp_fibroblastI[, c(3, 1)]
r_sp_fibroblastII <- significant_cor_sp_fibroblastII[, c(3, 1)]
r_sp_Pericyte <- significant_cor_sp_Pericyte[, c(3, 1)]
r_sp_endothelialI <- significant_cor_sp_endothelialI[, c(3, 1)]
r_sp_endothelialII <- significant_cor_sp_endothelialII[, c(3, 1)]
r_sp_lym_endothelial <- significant_cor_sp_lym_endothelial[, c(3, 1)]
r_sp_lymphocyte <- significant_cor_sp_lymphocyte[, c(3, 1)]
r_sp_macrophage <- significant_cor_sp_macrophage[, c(3, 1)]
r_sp_mesothelial <- significant_cor_sp_mesothelial[, c(3, 1)]
r_sp_neuronal <- significant_cor_sp_neuronal[, c(3, 1)]

r_sp <- list(r_sp_vsmc, r_sp_vsmcII, r_sp_fibroblastI, r_sp_fibroblastII, r_sp_Pericyte, r_sp_endothelialI, r_sp_endothelialII, r_sp_lym_endothelial, r_sp_lymphocyte, r_sp_macrophage, r_sp_mesothelial, r_sp_neuronal)

sp_list_genes <- reshape::merge_recurse(r_sp)
#sp_list_genes

r_sp_list_genes <- reshape::merge_recurse(r_sp)
#r_sp_list_genes
```

##heatmap with spearman correlation plot
```{r}
# Convert to matrix
#sp_list_genes
rownames(sp_list_genes) <- sp_list_genes$Gene
sp_list_genes <- sp_list_genes[, -1]

pval_mat <- as.matrix(sp_list_genes)
#pval_mat

#str(pval_mat)

# Save the rownames first
gene_names <- rownames(pval_mat)

# Convert the matrix values to numeric safely
pval_mat <- apply(pval_mat, 2, function(x) as.numeric(as.character(x)))
pval_mat <- as.matrix(pval_mat)

#pval_mat[is.infinite(pval_mat)] <- 0  # replace Inf/-Inf, just in case

# Restore the rownames
rownames(pval_mat) <- gene_names

#head(pval_mat)
x <- pval_mat %>% replace(is.na(.), 0)
```

```{r}
library(gplots)
library(ComplexHeatmap)

png("/home/mchopra/Documents/PhD-Year1/deconvolution/Deconvolution_results/results/with_batchs/hires/hires_age_associations/Heatmap_age.png")
Heatmap(x,
        show_row_names = FALSE,   # hide long row labels
        cluster_columns = TRUE,
        cluster_rows = TRUE,
        use_raster = TRUE,        # renders faster
        name = "ρ (rho)")
dev.off()
```
